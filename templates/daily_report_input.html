<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>日報入力画面</title>

    <style>
        .task-block {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>

    <script>
        // 初期値はサーバーからのtasks数。0件なら1にする。
        let taskCount = {{ task_count }};

        function addTask() {
            if (taskCount >= 3) return;
            taskCount++;
            const taskTemplate = document.getElementById("task-template");
            const clone = taskTemplate.cloneNode(true);
            clone.removeAttribute("id");
            clone.style.display = "block";

            // 削除ボタン表示
            const deleteBtn = clone.querySelector(".delete-btn");
            deleteBtn.style.display = "inline";
            deleteBtn.onclick = function () {
                clone.remove();
                taskCount--;
                updateAddButton();
            };

            document.getElementById("tasks-container").appendChild(clone);
            updateAddButton();
        }

        function updateAddButton() {
            document.getElementById("add-btn").style.display = taskCount < 3 ? "inline" : "none";
        }

        function clearForm() {
            document.querySelector("form").reset();
            const container = document.getElementById("tasks-container");
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            taskCount = 1;
            updateAddButton();
        }
    </script>

</head>

<body>

    <h1>{{ report_date }} の日報入力</h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="alert alert-success">
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <form method="POST">
        <label>日付:</label>
        <input type="text" name="report_date" value="{{ report_date }}" readonly>

        <label>体調:</label>
        <select name="condition">
            <option value="良好" {% if condition == '良好' %}selected{% endif %}>良好</option>
            <option value="普通" {% if condition == '普通' %}selected{% endif %}>普通</option>
            <option value="悪い" {% if condition == '悪い' %}selected{% endif %}>悪い</option>
        </select>

        <label>出勤時間:</label>
        <input type="time" name="start_time" value="{{ start_time }}" required>

        <label>退勤時間:</label>
        <input type="time" name="end_time" value="{{ end_time }}" required>

        <hr>

        <div id="tasks-container">
            {% if tasks and tasks|length > 0 %}
                {% for task in tasks %}
                    <div class="task-block">
                        <label>作業内容:</label>
                        <select name="work_detail[]">
                            <option value="清掃" {% if task.task_name == '清掃' %}selected{% endif %}>清掃</option>
                            <option value="パソコン設定" {% if task.task_name == 'パソコン設定' %}selected{% endif %}>パソコン設定</option>
                            <option value="発送準備・検品" {% if task.task_name == '発送準備・検品' %}selected{% endif %}>発送準備・検品</option>
                            <option value="データ入力" {% if task.task_name == 'データ入力' %}selected{% endif %}>データ入力</option>
                            <option value="資料準備・確認" {% if task.task_name == '資料準備・確認' %}selected{% endif %}>資料準備・確認</option>
                            <option value="備品移動" {% if task.task_name == '備品移動' %}selected{% endif %}>備品移動</option>
                            <option value="パソコンスキル" {% if task.task_name == 'パソコンスキル' %}selected{% endif %}>パソコンスキル</option>
                            <option value="タイピング" {% if task.task_name == 'タイピング' %}selected{% endif %}>タイピング</option>
                            <option value="軽作業" {% if task.task_name == '軽作業' %}selected{% endif %}>軽作業</option>
                            <option value="面接対策" {% if task.task_name == '面接対策' %}selected{% endif %}>面接対策</option>
                            <option value="応募書類作成" {% if task.task_name == '応募書類作成' %}selected{% endif %}>応募書類作成</option>
                            <option value="その他" {% if task.task_name == 'その他' %}selected{% endif %}>その他</option>
                        </select>

                        <label>作業時間(0.25単位):</label>
                        <input type="number" name="work_time[]" step="0.25" min="0" value="{{ task.task_duration }}" required>

                        <label>利用者によるコメント:</label>
                        <textarea name="user_comment[]" maxlength="300">{{ task.task_note }}</textarea>

                        <button type="button" class="delete-btn" onclick="this.parentElement.remove()">削除</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="task-block" id="task-template">
                    <label>作業内容:</label>
                    <select name="work_detail[]">
                        <option value="清掃">清掃</option>
                        <option value="パソコン設定">パソコン設定</option>
                        <option value="発送準備・検品">発送準備・検品</option>
                        <option value="データ入力">データ入力</option>
                        <option value="資料準備・確認">資料準備・確認</option>
                        <option value="備品移動">備品移動</option>
                        <option value="パソコンスキル">パソコンスキル</option>
                        <option value="タイピング">タイピング</option>
                        <option value="軽作業">軽作業</option>
                        <option value="面接対策">面接対策</option>
                        <option value="応募書類作成">応募書類作成</option>
                        <option value="その他">その他</option>
                    </select>

                    <label>作業時間(0.25単位):</label>
                    <input type="number" name="work_time[]" step="0.25" min="0" required>

                    <label>利用者によるコメント:</label>
                    <textarea name="user_comment[]" maxlength="300"></textarea>

                    <button type="button" class="delete-btn" style="display:none">削除</button>
                </div>
            {% endif %}
        </div>

        <button type="button" id="add-btn" onclick="addTask()">追加</button>

        <div style="margin-top: 20px;">
            <button type="submit">保存</button>
            <button type="button" onclick="clearForm()">クリア</button>
            <button type="button" onclick="window.location.href='{{ url_for('main') }}'">メインへ戻る</button>
        </div>
    </form>

</body>

</html>